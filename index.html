<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body {font-family:"Arial","Noto Sans TC",sans-serif;background:#f0f4f8;display:flex;justify-content:center;padding:20px;margin:0;}
.card {background:#fff;width:95%;max-width:480px;border-radius:20px;padding:25px 20px;display:flex;flex-direction:column;align-items:center;gap:20px;box-shadow:0 15px 30px rgba(0,0,0,0.15);}
#userInfo {font-size:28px;font-weight:bold;text-align:center;color:#2c3e50;}
#dateTime {font-size:22px;color:#7f8c8d;text-align:center;}
#statusInfo {font-size:20px;color:white;padding:8px 25px;border-radius:25px;text-align:center;min-width:180px;}
.buttons-container {display:flex;gap:15px;width:100%;}
.buttons-container button {flex:1;padding:15px 0;font-size:22px;font-weight:bold;border-radius:12px;border:none;cursor:pointer;color:white;transition:all 0.2s;}
#btnStart {background: linear-gradient(135deg, #3498db, #2980b9);}
#btnEnd {background: linear-gradient(135deg, #2ecc71, #27ae60);}
button:disabled {opacity:0.5;cursor:not-allowed;}
#todayRecords {width:100%;background:#fafafa;border-radius:14px;padding:15px;border:1px solid #ddd;font-size:18px;text-align:left;}
#todayRecords span {display:block;margin-bottom:5px;padding-left:5px;border-left:3px solid #3498db;}
</style>
</head>
<body>
<div class="card">
  <div id="userInfo">è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šä¸­...</div>
  <div id="statusInfo">å®šä½ç¢ºèªä¸­â€¦</div>
  <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>
  <div class="buttons-container">
    <button id="btnStart" disabled>ä¸Šç­</button>
    <button id="btnEnd" disabled>ä¸‹ç­</button>
  </div>
  <div id="todayRecords">ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆé»æ“Šæ›´æ–°ï¼‰</div>
</div>

<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbzLv3gV4fEjtNnPWX5PxbcmpWkaoxeI8LsHvxizdnFksOj_9uF7TMGBYQ00yn5O3RFZ/exec"; // â†æ”¹æˆä½ çš„GASéƒ¨ç½²ç¶²å€
let userId="", userName="", dataReady=false;
let statusLoaded=false;

const btnStart=document.getElementById("btnStart");
const btnEnd=document.getElementById("btnEnd");
const userInfo=document.getElementById("userInfo");
const statusInfo=document.getElementById("statusInfo");
const dateTime=document.getElementById("dateTime");
const todayRecords=document.getElementById("todayRecords");

/* ===== æ—¥æœŸå­—ä¸² yyyy/MM/dd ===== */
function getTodayString(){
  const d=new Date();
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
}

/* ===== æŒ‰éˆ•é–å®š ===== */
function setButtonsLock(lock){
  btnStart.disabled=lock;
  btnEnd.disabled=lock;
}

/* ===== æ™‚é–“é¡¯ç¤º ===== */
function updateDateTime(){
  const now=new Date();
  dateTime.textContent=now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

/* ===== å–å¾— IP ===== */
async function getIP(){
  const cache=sessionStorage.getItem("myIP");
  if(cache) return cache;
  try{
    const res=await fetch("https://api.ipify.org?format=json");
    const data=await res.json();
    sessionStorage.setItem("myIP", data.ip);
    return data.ip;
  }catch{return ""; }
}

/* ===== GPS å¿«å– ===== */
let lastGPS=null,lastGPSAt=0;
function getCachedGPS(maxAge=15000){
  return new Promise((resolve,reject)=>{
    const now=Date.now();
    if(lastGPS && now-lastGPSAt<maxAge){resolve(lastGPS);return;}
    navigator.geolocation.getCurrentPosition(
      pos=>{lastGPS={lat:pos.coords.latitude,lng:pos.coords.longitude};lastGPSAt=Date.now();resolve(lastGPS);},
      err=>reject(err),
      {enableHighAccuracy:false,timeout:5000}
    );
  });
}

/* ===== LIFF ä½¿ç”¨è€…åˆå§‹åŒ– ===== */
async function initUser(){
  await liff.init({liffId:"2008786085-L1CtKqqv"});
  if(!liff.isLoggedIn()) await liff.login();
  const profile=await liff.getProfile();
  userId=profile.userId;
  userName=profile.displayName;
  userInfo.textContent=`${userName} æ‚¨å¥½`;
}

/* ===== æ›´æ–°æ‰“å¡å€ç‹€æ…‹ ===== */
async function updateStatus(){
  statusInfo.textContent = "å®šä½è¼‰å…¥ä¸­â€¦";
  statusInfo.style.background = "#95a5a6";
  try{
    const [ip, gps] = await Promise.all([getIP(), getCachedGPS()]);
    const res = await fetch(`${API_ENDPOINT}?action=check&lat=${gps.lat}&lng=${gps.lng}&ip=${ip}`);
    const data = await res.json();

    if(data.rangeStatus === "æœ‰æ•ˆæ‰“å¡å€"){
      statusInfo.style.background = "#2ecc71";
      statusInfo.textContent = "æœ‰æ•ˆæ‰“å¡å€";
    } else {
      statusInfo.style.background = "#e67e22";
      const distText = data.distance !== null ? ` (${data.distance} å…¬å°º)` : "";
      statusInfo.textContent = "ç„¡æ•ˆæ‰“å¡å€" + distText;
    }
    statusLoaded = true;
  } catch(err){
    statusInfo.textContent = "å®šä½ç¢ºèªä¸­â€¦";
    statusInfo.style.background = "#95a5a6";
    console.warn("æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼š", err);
  }
}

/* ===== æ›´æ–°ä»Šæ—¥æ‰“å¡ç´€éŒ„ ===== */
async function updateTodayRecords(){
  todayRecords.innerHTML="è¼‰å…¥ä¸­...";
  try{
    const res=await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${getTodayString()}`);
    const data=await res.json();
    if(!data.length){todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡";return;}
    todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>";
    data.forEach(r=>{
      todayRecords.innerHTML+=`<span>${r.status}ï¼š${r.time}ï¼ˆ${r.company}ï¼‰</span>`;
    });
  }catch{todayRecords.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";}
}

/* ===== ç™¼é€ Flex Message çµ¦è‡ªå·± ===== */
async function sendSelfMessage({success, userName, status, date, time, company}){
  if(!liff.isInClient()) return;
  let headerColor = "#e67e22";
  let headerTitle = "æ‰“å¡å¤±æ•—é€šçŸ¥";
  if(success){
    if(status==="ä¸Šç­") headerColor="#3498db";
    else if(status==="ä¸‹ç­") headerColor="#2ecc71";
    headerTitle="æ‰“å¡æˆåŠŸé€šçŸ¥";
  }
  try{
    await liff.sendMessages([{
      type:"flex",
      altText:`${status}æ‰“å¡${success?"æˆåŠŸ":"å¤±æ•—"}`,
      contents:{
        type:"bubble",
        header:{
          type:"box",
          layout:"vertical",
          backgroundColor:headerColor,
          paddingAll:"12px",
          contents:[{type:"text",text:headerTitle,weight:"bold",size:"lg",color:"#ffffff"}]
        },
        body:{
          type:"box",
          layout:"vertical",
          spacing:"md",
          contents:[
            {type:"text",text:`å§“åï¼š${userName}`,size:"md"},
            {type:"text",text:`ç‹€æ…‹ï¼š${status}`,size:"md"},
            {type:"text",text:`æ™‚é–“ï¼š${date} ${time}`,size:"md"},
            {type:"text",text:`åœ°é»ï¼š${company}`,size:"md"}
          ]
        }
      }
    }]);
  }catch(err){console.error("è¨Šæ¯å‚³é€å¤±æ•—:",err);}
}

/* ===== æ‰“å¡åŠŸèƒ½ ===== */
async function clockInOut(status){
  if(!dataReady){Swal.fire({icon:"info",title:"è³‡æ–™è®€å–ä¸­",timer:1500,showConfirmButton:false}); return;}
  if(!statusLoaded){Swal.fire({icon:"info",title:"å®šä½ä¸­ï¼Œè«‹ç¨å€™",timer:1500,showConfirmButton:false}); return;}

  const btn = status==="ä¸Šç­"?btnStart:btnEnd;
  btn.disabled=true;
  const originalText = btn.textContent;
  let sec=3;
  const timer=setInterval(()=>{btn.textContent=`æ‰“å¡ä¸­â€¦ ${sec}s`; sec--; if(sec<0) clearInterval(timer);},1000);

  try{
    const ip=await getIP();
    const gps=await getCachedGPS();
    const res=await fetch(API_ENDPOINT,{
      method:"POST",
      body:JSON.stringify({userId,userName,ip,gps,status})
    });
    const data=await res.json();
    const companyName=data.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"?data.company||"æœªçŸ¥åœ°é»":"éŒ¯èª¤-ç•°åœ°è«‹å¿½ç•¥";

    if(data.rangeStatus==="æœ‰æ•ˆæ‰“å¡å€"){
      Swal.fire({icon:"success",title:"ğŸ‰ æ‰“å¡æˆåŠŸï¼",html:`<strong>æ‰“å¡æ™‚é–“ï¼š</strong> ${data.date} ${data.time}`,showConfirmButton:false,timer:2000,backdrop:"rgba(0,0,0,0.5)"});
      sendSelfMessage({success:true,userName,userName,status,date:data.date,time:data.time,company:companyName});
    }else{
      Swal.fire({icon:"warning",title:`<span style="font-size:20px;color:#e67e22;">âš  æ‰“å¡ç„¡æ•ˆ</span>`,html:`<div style="font-size:16px;color:#3498db;font-weight:bold;margin-top:8px;">â— ç•°åœ°æ‰“å¡è«‹å¿½ç•¥ â—</div>`,showConfirmButton:false,timer:2000,backdrop:"rgba(0,0,0,0.5)"});
      sendSelfMessage({success:false,userName,status,date:data.date,time:data.time||"",company:companyName});
    }

    updateTodayRecords();
    updateStatus();
  }catch{
    Swal.fire({icon:"error",title:"ğŸ˜¥ æ‰“å¡å¤±æ•—",html:"è«‹æŸ¥çœ‹ç´€éŒ„",showConfirmButton:false,timer:2000,backdrop:"rgba(0,0,0,0.5")});
  }finally{
    clearInterval(timer);
    btn.textContent=originalText;
    btn.disabled=false;
  }
}

btnStart.onclick=()=>clockInOut("ä¸Šç­");
btnEnd.onclick=()=>clockInOut("ä¸‹ç­");

/* ===== åˆå§‹åŒ– ===== */
window.onload=async()=>{
  setButtonsLock(true);
  await initUser();
  setButtonsLock(false);
  dataReady=true;
  updateStatus();
  updateTodayRecords();
  setInterval(updateStatus,15000);       // æ¯ 15 ç§’æ›´æ–°æ‰“å¡å€
  setInterval(updateTodayRecords,30000); // æ¯ 30 ç§’åˆ·æ–°ä»Šæ—¥ç´€éŒ„
};
</script>
</body>
</html>































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































